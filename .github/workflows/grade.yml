name: Autograding

on: 
  workflow_call:
    inputs:
      secrets:
        personal_access_token:
          required: true
        is_local:
          require: true
        pr_number:
          required: true
        repository:
          require: true

env:
  internal_pat: ${{ secrets.personal_access_token }}
  is_local: ${{ secrets.is_local }}
  pr_number: ${{ secrets.pr_number }}
  repository: ${{ secrets.repository }}

jobs:
  autograding:
    runs-on: ubuntu-22.04
    steps:
      - name: Installing Python (only on act)
        if: ${{ env.is_local }}
        run: | 
          apt update
          apt install -y python3 python3-pip git
      - name: Set repository name
        run: echo "REPO_NAME=$(echo ${{ env.repository }} | cut -d'/' -f2)" >> $GITHUB_ENV
      - name: All environment variables
        if: ${{ env.is_local }}
        run: |
          echo ${{ env.internal_pat }}
          echo ${{ env.is_local }}
          echo ${{ env.pr_number }}
          echo ${{ env.repository }}
          echo ${{ env.REPO_NAME }}
      - name: Checking out current repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.repository }}
          token: ${{ env.internal_pat }}
          path: main
      - name: Checking out solutions repository
        uses: actions/checkout@v4
        with:
          repository: git-mastery/solution-${{ env.REPO_NAME }}
          token: ${{ env.internal_pat }}
          path: solution/
      - name: Setup Python (only on Github Actions)
        if: ${{ ! env.is_local }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Installing Python dependencies
        run: |
          pip install GitPython PyGithub
      - name: Run Python
        run: python3 grade.py
        working-directory: solution
            

